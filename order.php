<?php
require_once __DIR__ . '/config/config.php';
require_once BASE_PATH . '/src/Utils/db.php';
require_once BASE_PATH . '/src/Services/PeakerrClient.php';
require_once BASE_PATH . '/src/Utils/auth.php';

Auth::startSession();
$currentUser = Auth::currentUser();

// ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
if (!$currentUser) {
    $_SESSION['redirect_after_login'] = $_SERVER['REQUEST_URI'] ?? '/order.php';
    header('Location: /auth/login.php');
    exit;
}

// ุณูุชู ุชุนููู pageTitle ู pageDescription ุจูุงุกู ุนูู ุงูุฎุฏูุฉ ุงููุญุฏุฏุฉ
$pageTitle = 'ุชุฃููุฏ ุงูุทูุจ';
$pageDescription = 'ุงุทูุจ ุฎุฏูุงุช ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู ูุงูุฃูุนุงุจ ุจุณูููุฉ ูุฃูุงู';
$ogType = 'product';
$message = '';
$messageType = '';

// ุงูุชุญูู ูู ุทุฑููุฉ ุงูุทูุจ - ุงูุณูุงุญ ุจู GET ููุงูุชูุงู ูู ุตูุญุฉ ุงูุฎุฏูุงุช
if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['service'])) {
    // ูุนุงูุฌุฉ GET request ูู ุตูุญุฉ ุงูุฎุฏูุงุช
    $serviceId = isset($_GET['service']) ? intval($_GET['service']) : 0;
    
    if (!$serviceId) {
        header('Location: /catalog.php');
        exit;
    }
    
    // ุฌูุจ ุจูุงูุงุช ุงูุฎุฏูุฉ
    try {
        $service = Database::fetchOne("SELECT * FROM services_cache WHERE id = ?", [$serviceId]);
        
        if (!$service) {
            $errorMessage = "ุงูุฎุฏูุฉ ุบูุฑ ููุฌูุฏุฉ";
            $pageTitle = 'ุฎุทุฃ - ุงูุฎุฏูุฉ ุบูุฑ ููุฌูุฏุฉ';
            $pageDescription = 'ุงูุฎุฏูุฉ ุงููุทููุจุฉ ุบูุฑ ูุชููุฑุฉ ุญุงููุงู';
            require_once BASE_PATH . '/templates/partials/header.php';
            echo '<div class="container"><div class="alert alert-error">' . $errorMessage . '</div></div>';
            require_once BASE_PATH . '/templates/partials/footer.php';
            exit;
        }
        
        // ุญุณุงุจ ุงูุณุนุฑ ูุฑุฉ ูุงุญุฏุฉ
        $price = $service['rate_per_1k_lyd'] ?: ($service['rate_per_1k'] * EXCHANGE_USD_TO_LYD);
        
        // ุชุญุฏูุซ ุนููุงู ุงูุตูุญุฉ ุจูุงุกู ุนูู ุงูุฎุฏูุฉ
        $pageTitle = 'ุทูุจ ุฎุฏูุฉ: ' . ($service['name_ar'] ?? $service['name']);
        $pageDescription = 'ุงุทูุจ ุฎุฏูุฉ ' . ($service['name_ar'] ?? $service['name']) . ' - ' . ($service['category_ar'] ?? $service['category']);
        
        // ุนุฑุถ ุตูุญุฉ ุงูุทูุจ
        require_once BASE_PATH . '/templates/partials/header.php';
        ?>
        
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav" style="margin-bottom: 1rem;">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">ุงูุฑุฆูุณูุฉ</a></li>
                    <li class="breadcrumb-item"><a href="/catalog.php">ุงูุฎุฏูุงุช</a></li>
                    <li class="breadcrumb-item"><a href="/service.php?id=<?php echo $service['id']; ?>"><?php echo htmlspecialchars($service['name_ar'] ?: $service['name']); ?></a></li>
                    <li class="breadcrumb-item active" aria-current="page">ุชุฃููุฏ ุงูุทูุจ</li>
                </ol>
            </nav>
            
            <div class="card">
                <div class="card-header">
                    <h1 class="card-title">ุชุฃููุฏ ุงูุทูุจ</h1>
                    <p class="card-subtitle">ุชุฃูุฏ ูู ุจูุงูุงุช ุงูุทูุจ ูุจู ุงูุฅุฑุณุงู</p>
                </div>
                
                <div class="card-body">
                    <!-- ุนุฑุถ ุจูุงูุงุช ุงูุฎุฏูุฉ -->
                    <div class="service-summary mb-4">
                        <h3><?php echo htmlspecialchars($service['name_ar'] ?: $service['name']); ?></h3>
                        <p><strong>ุงูุชุตููู:</strong> <?php echo htmlspecialchars($service['category_ar'] ?: $service['category']); ?></p>
                        <p><strong>ุงูููุน:</strong> <?php echo htmlspecialchars($service['subcategory'] ?: $service['type']); ?></p>
                        <p><strong>ุงููููุฉ:</strong> <?php echo Formatters::formatQuantity($service['min']); ?> - <?php echo Formatters::formatQuantity($service['max']); ?></p>
                        <p><strong>ุงูุณุนุฑ:</strong> 
                            <?php echo Formatters::formatMoneyCompact($price); ?> LYD ููู 1000
                        </p>
                        <div class="total-price-display" style="background: rgba(201, 162, 39, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <p><strong>ุงูุณุนุฑ ุงูุฅุฌูุงูู:</strong> <span id="total-price" class="price-highlight">0.00 LYD</span></p>
                        </div>
                    </div>
                    
        <!-- ูููุฐุฌ ุงูุทูุจ -->
        <form method="POST" action="/order.php">
            <?php echo Auth::csrfField(); ?>
            <input type="hidden" name="service_id" value="<?php echo htmlspecialchars($service['id']); ?>">
                        
                        <div class="form-group">
                            <label for="quantity" class="form-label">ุงููููุฉ ุงููุทููุจุฉ:</label>
                            
                            <!-- Quick quantity chips -->
                            <div class="group-pills" style="margin-bottom: 0.75rem;">
                                <?php
                                $quickQuantities = [];
                                $min = (int)$service['min'];
                                $max = (int)$service['max'];
                                
                                // Add common quantities within range
                                if ($min <= 100 && $max >= 100) $quickQuantities[] = 100;
                                if ($min <= 500 && $max >= 500) $quickQuantities[] = 500;
                                if ($min <= 1000 && $max >= 1000) $quickQuantities[] = 1000;
                                if ($min <= 5000 && $max >= 5000) $quickQuantities[] = 5000;
                                
                                foreach ($quickQuantities as $qty): ?>
                                    <button type="button" class="group-pill" onclick="setQuantity(<?php echo $qty; ?>)"><?php echo number_format($qty); ?></button>
                                <?php endforeach; ?>
                            </div>
                            
                            <input type="number" 
                                   id="quantity" 
                                   name="quantity" 
                                   class="form-control" 
                                   min="<?php echo $service['min']; ?>" 
                                   max="<?php echo $service['max']; ?>"
                                   step="1"
                                   inputmode="numeric"
                                   pattern="[0-9]*"
                                   value="<?php echo $service['min']; ?>"
                                   aria-describedby="quantity-hint"
                                   required>
                            <div class="form-hint" id="quantity-hint">
                                <span>ุงูุญุฏ: <?php echo number_format($service['min']); ?> - <?php echo number_format($service['max']); ?></span>
                                <span style="margin-right: 1rem;">โฑ๏ธ ุงูุชุณููู: 0-24 ุณุงุนุฉ</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="target" class="form-label">ุงูุฑุงุจุท ุฃู ุงุณู ุงููุณุชุฎุฏู:</label>
                            <input type="url" 
                                   id="target" 
                                   name="target" 
                                   class="form-control" 
                                   placeholder="https://example.com/username ุฃู @username"
                                   aria-describedby="target-hint"
                                   required>
                            <div class="form-hint" id="target-hint">
                                <span>๐ ุฑุงุจุท ูุงูู ุฃู ุงุณู ุงููุณุชุฎุฏู ููุท</span>
                                <span style="margin-right: 1rem;">๐ ุขูู ููุญูู</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes" class="form-label">ููุงุญุธุงุช (ุงุฎุชูุงุฑู):</label>
                            <textarea id="notes" 
                                      name="notes" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ..."></textarea>
                        </div>
                        
                        <div class="form-group" style="position: sticky; bottom: 1rem; z-index: 10; background: var(--color-card); padding: 1rem 0; margin-top: 2rem; border-top: 1px solid var(--color-border);">
                            <button type="submit" class="btn btn-primary btn-block" style="margin-bottom: 1rem;">
                                โ ุชุฃููุฏ ุงูุทูุจ
                            </button>
                            <a href="/catalog.php" class="btn btn-secondary btn-block">
                                โ ุงูุนูุฏุฉ ููุฎุฏูุงุช
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <script>
        // ุญุณุงุจ ุงูุณุนุฑ ุงูุฅุฌูุงูู - ูุณุฎุฉ ูุจุณุทุฉ ููุญุณูุฉ
        document.addEventListener('DOMContentLoaded', function() {
            var quantityInput = document.getElementById('quantity');
            var totalPriceElement = document.getElementById('total-price');
            
            // Get price from PHP
            var pricePer1k = parseFloat(<?php echo json_encode($price ?? 0); ?>);
            var minQty = parseInt(<?php echo json_encode($service['min'] ?? 1); ?>);
            var maxQty = parseInt(<?php echo json_encode($service['max'] ?? 1000000); ?>);
            
            if (!quantityInput || !totalPriceElement) {
                return;
            }
            
            if (!pricePer1k || pricePer1k <= 0) {
                totalPriceElement.textContent = 'ุณุนุฑ ุบูุฑ ุตุญูุญ';
                return;
            }
            
            // Function to update total price
            function updateTotalPrice() {
                var quantity = parseInt(quantityInput.value) || 0;
                var totalPrice = (quantity / 1000) * pricePer1k;
                totalPriceElement.textContent = totalPrice.toFixed(2) + ' LYD';
            }
            
            // Function to validate quantity
            function validateQuantity() {
                var val = parseInt(quantityInput.value);
                if (val < minQty) {
                    quantityInput.setCustomValidity('ุงููููุฉ ูุฌุจ ุฃู ุชููู ุนูู ุงูุฃูู ' + minQty);
                } else if (val > maxQty) {
                    quantityInput.setCustomValidity('ุงููููุฉ ูุฌุจ ุฃูุง ุชุชุฌุงูุฒ ' + maxQty);
                } else {
                    quantityInput.setCustomValidity('');
                }
            }
            
            // Global function for quick quantity setting
            window.setQuantity = function(qty) {
                quantityInput.value = qty;
                validateQuantity();
                updateTotalPrice();
                
                // Update active state of chips
                var chips = document.querySelectorAll('.group-pill');
                chips.forEach(function(chip) {
                    chip.classList.remove('active');
                });
                
                // Find and activate the clicked chip
                var clickedChip = document.querySelector('.group-pill[onclick*="' + qty + '"]');
                if (clickedChip) {
                    clickedChip.classList.add('active');
                }
            };
            
            // Event listeners
            quantityInput.addEventListener('input', function() {
                validateQuantity();
                updateTotalPrice();
            });
            
            quantityInput.addEventListener('change', function() {
                validateQuantity();
                updateTotalPrice();
            });
            
            quantityInput.addEventListener('keyup', function() {
                validateQuantity();
                updateTotalPrice();
            });
            
            // Initialize
            updateTotalPrice();
        });
        </script>
        
        <?php
        require_once BASE_PATH . '/templates/partials/footer.php';
        exit;
        
    } catch (Exception $e) {
        ErrorHandler::handleDatabaseError($e, "ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงูุฎุฏูุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.");
    }
}

// ูุนุงูุฌุฉ POST request (ุงูุทูุจ ุงููุนูู)
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: /catalog.php');
    exit;
}

// Rate limiting - 5 orders per 5 minutes per session/IP
$rateLimitKey = 'order_attempts_' . (session_id() ?: $_SERVER['REMOTE_ADDR']);
$currentTime = time();
$timeWindow = 300; // 5 minutes
$maxAttempts = 5;

if (!isset($_SESSION['rate_limits'])) {
    $_SESSION['rate_limits'] = [];
}

// Clean old entries
if (isset($_SESSION['rate_limits'][$rateLimitKey])) {
    $_SESSION['rate_limits'][$rateLimitKey] = array_filter(
        $_SESSION['rate_limits'][$rateLimitKey],
        function($timestamp) use ($currentTime, $timeWindow) {
            return ($currentTime - $timestamp) < $timeWindow;
        }
    );
}

// Check rate limit
$attempts = $_SESSION['rate_limits'][$rateLimitKey] ?? [];
if (count($attempts) >= $maxAttempts) {
    error_log("Rate limit exceeded for order submission - IP: " . $_SERVER['REMOTE_ADDR'] . " - Session: " . session_id());
    
    $pageTitle = 'ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ';
    $pageDescription = 'ุชู ุชุฌุงูุฒ ุนุฏุฏ ุงููุญุงููุงุช ุงููุณููุญ ุจูุง';
    require_once BASE_PATH . '/templates/partials/header.php';
    ?>
    <div class="container">
        <div class="alert alert-error">
            <strong>โฐ ูุฑุฌู ุงูุงูุชุธุงุฑ ููููุงู</strong><br>
            ููุฏ ุชุฌุงูุฒุช ุนุฏุฏ ุงููุญุงููุงุช ุงููุณููุญ ุจูุง (<?php echo $maxAttempts; ?> ุทูุจุงุช ูู 5 ุฏูุงุฆู).<br>
            ูุฑุฌู ุงูุงูุชุธุงุฑ ุจุถุน ุฏูุงุฆู ูุจู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.
            <div style="margin-top: 1rem;">
                <a href="/catalog.php" class="btn btn-secondary">โ ุงูุนูุฏุฉ ููุฎุฏูุงุช</a>
            </div>
        </div>
    </div>
    <?php
    require_once BASE_PATH . '/templates/partials/footer.php';
    exit;
}

// Record this attempt
$_SESSION['rate_limits'][$rateLimitKey][] = $currentTime;

        // ุงูุชุญูู ูู CSRF token
        try {
            Auth::requireCsrf();
        } catch (Exception $e) {
            $errorMessage = "ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุฃูุงู. ูุฑุฌู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.";
            $pageTitle = 'ุฎุทุฃ ูู ุงูุฃูุงู';
            $pageDescription = 'ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุฃูุงู';
            require_once BASE_PATH . '/templates/partials/header.php';
            echo '<div class="container">';
            echo '<div class="alert alert-error">';
            echo '<h3>ุฎุทุฃ ูู ุงูุฃูุงู</h3>';
            echo '<p>' . htmlspecialchars($errorMessage) . '</p>';
            echo '<div style="margin-top: 1rem;">';
            echo '<a href="javascript:history.back()" class="btn btn-secondary">โ ุงูุนูุฏุฉ</a> ';
            echo '<a href="/order.php?service=' . urlencode($_POST['service_id'] ?? '') . '" class="btn btn-primary">ุฅุนุงุฏุฉ ุงููุญุงููุฉ</a>';
            echo '</div>';
            echo '</div>';
            echo '</div>';
            require_once BASE_PATH . '/templates/partials/footer.php';
            exit;
        }

// Normalize and validate inputs
error_log("Order processing - Starting input validation");
$serviceId = isset($_POST['service_id']) ? intval($_POST['service_id']) : 0;
$quantity = isset($_POST['quantity']) ? intval($_POST['quantity']) : 0;
$target = isset($_POST['target']) ? mb_substr(trim($_POST['target']), 0, 255, 'UTF-8') : '';

error_log("Order processing - Validated inputs: serviceId=$serviceId, quantity=$quantity, target=$target");
$notes = isset($_POST['notes']) ? mb_substr(trim($_POST['notes']), 0, 1000, 'UTF-8') : '';

// Validation
error_log("Order processing - Starting validation");
if (!$serviceId || $serviceId <= 0) {
    $errorMessage = "ูุนุฑู ุงูุฎุฏูุฉ ุบูุฑ ุตุญูุญ";
    require_once BASE_PATH . '/templates/partials/header.php';
    echo '<div class="container"><div class="alert alert-error">' . htmlspecialchars($errorMessage) . '</div></div>';
    require_once BASE_PATH . '/templates/partials/footer.php';
    exit;
}

if (!$quantity || $quantity <= 0) {
    $errorMessage = "โ ุงููููุฉ ุบูุฑ ุตุญูุญุฉ - ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุตุญูุญ";
    $pageTitle = 'ุฎุทุฃ ูู ุงูุจูุงูุงุช';
    $pageDescription = 'ุฎุทุฃ ูู ุจูุงูุงุช ุงูุทูุจ ุงููุฏุฎูุฉ';
    require_once BASE_PATH . '/templates/partials/header.php';
    echo '<div class="container"><div class="alert alert-error"><strong>ุฎุทุฃ ูู ุงููููุฉ:</strong> ' . htmlspecialchars($errorMessage) . '<br><a href="javascript:history.back()" class="btn btn-secondary" style="margin-top: 1rem;">โ ุงูุนูุฏุฉ ูุฅุนุงุฏุฉ ุงููุญุงููุฉ</a></div></div>';
    require_once BASE_PATH . '/templates/partials/footer.php';
    exit;
}

if (empty($target)) {
    $errorMessage = "๐ ูุฑุฌู ุฅุฏุฎุงู ุงูุฑุงุจุท ุฃู ุงุณู ุงููุณุชุฎุฏู";
    $pageTitle = 'ุฎุทุฃ ูู ุงูุจูุงูุงุช';
    $pageDescription = 'ุจูุงูุงุช ุงููุฏู ููููุฏุฉ ูู ุงูุทูุจ';
    require_once BASE_PATH . '/templates/partials/header.php';
    echo '<div class="container"><div class="alert alert-error"><strong>ุจูุงูุงุช ููููุฏุฉ:</strong> ' . htmlspecialchars($errorMessage) . '<br><small style="opacity: 0.8;">ูุซุงู: https://instagram.com/username ุฃู @username</small><br><a href="javascript:history.back()" class="btn btn-secondary" style="margin-top: 1rem;">โ ุงูุนูุฏุฉ ูุฅุนุงุฏุฉ ุงููุญุงููุฉ</a></div></div>';
    require_once BASE_PATH . '/templates/partials/footer.php';
    exit;
}

error_log("Order processing - Validation passed");

// ุฌูุจ ุจูุงูุงุช ุงูุฎุฏูุฉ
try {
    $service = Database::fetchOne(
        "SELECT * FROM services_cache WHERE id = ?",
        [$serviceId]
    );
    
    if (!$service) {
        throw new Exception("ุงูุฎุฏูุฉ ุบูุฑ ููุฌูุฏุฉ");
    }
    
    // ุงูุชุญูู ูู ุญุฏูุฏ ุงููููุฉ
    if ($quantity < $service['min'] || $quantity > $service['max']) {
        throw new Exception("ุงููููุฉ ูุฌุจ ุฃู ุชููู ุจูู " . number_format($service['min']) . " ู " . number_format($service['max']));
    }
    
    // ุญุณุงุจ ุงูุณุนุฑ ุจุงูู LYD
    $rateLyd = isset($service['rate_per_1k_lyd']) && $service['rate_per_1k_lyd'] !== null
        ? (float)$service['rate_per_1k_lyd']
        : ((float)(isset($service['rate_per_1k']) ? $service['rate_per_1k'] : 0) * EXCHANGE_USD_TO_LYD);
    
    $totalPrice = round(($rateLyd / 1000.0) * $quantity, 2);
    
    // ุงูุชุญูู ูู ุงูุฑุตูุฏ ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
    if ($currentUser) {
        $wallet = Database::fetchOne("SELECT balance FROM wallets WHERE user_id = ?", [$currentUser['id']]);
        $balance = $wallet ? (float)$wallet['balance'] : 0.0;
        
        if ($balance < $totalPrice) {
            $supportMsg = 'ูุฑุญุจุงูุ ุฃุญุชุงุฌ ูุณุงุนุฏุฉ ุจุฎุตูุต ุดุญู ุงููุญูุธุฉ - ุฑุตูุฏู ุงูุญุงูู: ' . Formatters::formatMoney($balance) . ' ูุงููุทููุจ: ' . Formatters::formatMoney($totalPrice);
            $supportUrl = 'https://wa.me/' . WHATSAPP_NUMBER . '?text=' . urlencode($supportMsg);
            $errorMessage = "๐ฐ ุนุฐุฑูุงุ ุฑุตูุฏ ูุญูุธุชู ุฃูู ูู ูููุฉ ุงูุทูุจ (ุฑุตูุฏู: " . Formatters::formatMoney($balance) . " | ุงููุทููุจ: " . Formatters::formatMoney($totalPrice) . ").";
            require_once BASE_PATH . '/templates/partials/header.php';
            ?>
            <div class="container">
                <div class="alert alert-error">
                    <strong>ุฑุตูุฏ ุบูุฑ ูุงูู:</strong> <?php echo $errorMessage; ?>
                    <div style="margin-top: 1rem;">
                        <a href="/wallet/topup.php" class="btn btn-primary" style="margin-left: 0.5rem;">๐ฐ ุดุญู ุงููุญูุธุฉ</a>
                        <a href="<?php echo htmlspecialchars($supportUrl); ?>" target="_blank" rel="noopener" class="btn btn-secondary">๐ฑ ูุณุงุนุฏุฉ ููุฑูุฉ</a>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <a href="/wallet/topup.php" class="btn btn-primary btn-lg">ุดุญู ุงููุญูุธุฉ</a>
                    </div>
                </div>
            </div>
            <?php
            require_once BASE_PATH . '/templates/partials/footer.php';
            exit;
        }
        
        // ุจุฏุก ูุนุงููุฉ ุฐุฑูุฉ ููุฎุตู
        Database::query("START TRANSACTION");
        
        try {
            // ุฎุตู ุงูุฑุตูุฏ
            Database::query(
                "INSERT INTO wallet_transactions (user_id, type, amount, status) VALUES (?, 'deduct', ?, 'approved')",
                [$currentUser['id'], $totalPrice]
            );
            
            Database::query(
                "INSERT INTO wallets (user_id, balance) VALUES (?, ?) ON DUPLICATE KEY UPDATE balance = balance - ?",
                [$currentUser['id'], -$totalPrice, $totalPrice]
            );
            
            // ุงูุชุญูู ูู ุฃู ุงูุฑุตูุฏ ูุง ูุฒุงู ููุฌุจุงู
            $newBalance = Database::fetchOne("SELECT balance FROM wallets WHERE user_id = ?", [$currentUser['id']]);
            if ($newBalance['balance'] < 0) {
                throw new Exception("ุฑุตูุฏ ุบูุฑ ูุงูู");
            }
            
            // ุชุญุฏูุฏ ููุน ุงููุฏู (ุฑุงุจุท ุฃู ุงุณู ูุณุชุฎุฏู)
            $isUrl = preg_match('~^https?://~i', $target ?? '');
            $link  = $isUrl ? $target : '';
            $usern = $isUrl ? '' : $target;
            
            // ุฅูุดุงุก ุงูุทูุจ ูู ุงููุฒููุฏ
            $peakerr = new PeakerrClient();
            $orderResult = $peakerr->createOrder(
                intval($service['external_id']),
                intval($quantity),
                $link,
                $usern
            );
            
            // ูุนุงูุฌุฉ ุงููุชูุฌุฉ
            if ($orderResult['ok']) {
                // ุงูุจุญุซ ุนู ููุงุชูุญ ุงูุฎุทุฃ ุงูุดุงุฆุนุฉ
                if (isset($orderResult['error']) || isset($orderResult['message'])) {
                    $errorMsg = $orderResult['error'] ?? $orderResult['message'];
                    throw new Exception("ุฎุทุฃ ูู ุงููุฒููุฏ: " . $errorMsg);
                }
                
                // ุฅุฐุง ูุงู ุงูุฑุฏ ูุตููุง ูู raw
                if (isset($orderResult['raw'])) {
                    throw new Exception("ูุดู ูู ุฅูุดุงุก ุงูุทูุจ - ุงุณุชุฌุงุจุฉ ุบูุฑ ูุชููุนุฉ ูู ุงููุฒููุฏ");
                }
                
                // ูุฌุญ ุงูุทูุจ
                if (isset($orderResult['order'])) {
                    // ุญูุธ ุงูุทูุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                    // ูุญุต ูุฌูุฏ ุนููุฏ notes ุฃููุงู
                    $notesColumnExists = Database::fetchOne("SHOW COLUMNS FROM orders LIKE 'notes'");
                    if ($notesColumnExists) {
                        Database::query(
                            "INSERT INTO orders (external_order_id, service_id, quantity, link, username, status, price_lyd, user_id, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)",
                            [
                                $orderResult['order'],
                                $service['id'],
                                $quantity,
                                $link,
                                $usern,
                                $orderResult['status'] ?? 'pending',
                                $totalPrice,
                                $currentUser['id'],
                                'ุทูุจ ูุน ุฑุตูุฏ ูุญูุธุฉ'
                            ]
                        );
                    } else {
                        Database::query(
                            "INSERT INTO orders (external_order_id, service_id, quantity, link, username, status, price_lyd, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?)",
                            [
                                $orderResult['order'],
                                $service['id'],
                                $quantity,
                                $link,
                                $usern,
                                $orderResult['status'] ?? 'pending',
                                $totalPrice,
                                $currentUser['id']
                            ]
                        );
                    }
                    
                    Database::query("COMMIT");
                    
                    $message = "ุชู ุฅูุดุงุก ุงูุทูุจ ุจูุฌุงุญ! ุฑูู ุงูุทูุจ: " . $orderResult['order'];
                    $messageType = 'success';
                    
                    // ุฅุนุงุฏุฉ ุชูุฌูู ูุตูุญุฉ ุงูุชุชุจุน
                    header('Location: /track.php?order=' . urlencode($orderResult['order']));
                    exit;
                } else {
                    throw new Exception("ูุดู ูู ุฅูุดุงุก ุงูุทูุจ - ูู ูุชู ุงูุญุตูู ุนูู ุฑูู ุงูุทูุจ");
                }
            } else {
                // ูุดู ุงูุทูุจ
                $errorMsg = $orderResult['error'] ?? "ุฎุทุฃ ุบูุฑ ูุนุฑูู";
                throw new Exception("ูุดู ูู ุฅูุดุงุก ุงูุทูุจ: " . $errorMsg);
            }
            
        } catch (Exception $e) {
            Database::query("ROLLBACK");
            throw $e;
        }
        
        } else {
            // ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูู - ุฅูุดุงุก ุทูุจ ุนุงุฏู
            $isUrl = preg_match('~^https?://~i', $target ?? '');
            $link  = $isUrl ? $target : '';
            $usern = $isUrl ? '' : $target;
            
            $peakerr = new PeakerrClient();
            $orderResult = $peakerr->createOrder(
                intval($service['external_id']),
                intval($quantity),
                $link,
                $usern
            );
        
            // ูุนุงูุฌุฉ ุงููุชูุฌุฉ ููุทูุจ ุจุฏูู ุชุณุฌูู ุฏุฎูู
            if ($orderResult['ok']) {
                // ุงูุชุญูู ูู ูุฌูุฏ ุฎุทุฃ ูู ุงูุงุณุชุฌุงุจุฉ
                if (isset($orderResult['error'])) {
                    $errorMsg = $orderResult['error'];
                    // ุฑุณุงุฆู ุฎุงุตุฉ ูุจุนุถ ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ
                    if (stripos($errorMsg, 'not enough funds') !== false || stripos($errorMsg, 'insufficient balance') !== false) {
                        $supportMsg = 'ูุฑุญุจุงูุ ุฃุญุชุงุฌ ูุณุงุนุฏุฉ ุจุฎุตูุต ุทูุจ ุฎุฏูุฉ: ' . ($service['name_ar'] ?? $service['name']) . ' - ุฑุตูุฏ ุงููุฒููุฏ ุบูุฑ ูุงูู';
                        $supportUrl = 'https://wa.me/' . WHATSAPP_NUMBER . '?text=' . urlencode($supportMsg);
                        throw new Exception("ุฑุตูุฏ ุงููุฒููุฏ ุบูุฑ ูุงูู. <a href=\"" . htmlspecialchars($supportUrl) . "\" target=\"_blank\" rel=\"noopener\" class=\"btn btn-secondary\" style=\"margin-right: 0.5rem;\">๐ฑ ุชูุงุตู ูุน ุงูุฏุนู</a>");
                    } elseif (stripos($errorMsg, 'invalid service') !== false) {
                        throw new Exception("ุงูุฎุฏูุฉ ุงููุทููุจุฉ ุบูุฑ ูุชุงุญุฉ ุญุงููุงู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.");
                    } elseif (stripos($errorMsg, 'rate limit') !== false) {
                        throw new Exception("ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ ูู ุงูุทูุจุงุช. ูุฑุฌู ุงููุญุงููุฉ ุจุนุฏ ูููู.");
                    } else {
                        throw new Exception("ุชุนุฐุฑ ุฅูุดุงุก ุงูุทูุจ ูุน ุงููุฒููุฏ. ุงูุฑุณุงูุฉ: " . $errorMsg);
                    }
                }
                if (isset($orderResult['message'])) {
                    throw new Exception("ุชุนุฐุฑ ุฅูุดุงุก ุงูุทูุจ ูุน ุงููุฒููุฏ. ุงูุฑุณุงูุฉ: " . $orderResult['message']);
                }
                if (isset($orderResult['raw'])) {
                    throw new Exception("ุชุนุฐุฑ ุฅูุดุงุก ุงูุทูุจ. ุฑุงุฌุน ุงูุฏุนู");
                }
                
                if (isset($orderResult['order'])) {
                    // ูุญุต ูุฌูุฏ ุนููุฏ notes ุฃููุงู
                    $notesColumnExists = Database::fetchOne("SHOW COLUMNS FROM orders LIKE 'notes'");
                    if ($notesColumnExists) {
                        Database::query(
                            "INSERT INTO orders (external_order_id, service_id, quantity, link, username, status, price_lyd, user_id, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)",
                            [
                                $orderResult['order'],
                                $service['id'],
                                $quantity,
                                $link,
                                $usern,
                                $orderResult['status'] ?? 'pending',
                                $totalPrice,
                                null, // user_id
                                'ุทูุจ ุจุฏูู ุชุณุฌูู ุฏุฎูู'
                            ]
                        );
                    } else {
                        Database::query(
                            "INSERT INTO orders (external_order_id, service_id, quantity, link, username, status, price_lyd, user_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?)",
                            [
                                $orderResult['order'],
                                $service['id'],
                                $quantity,
                                $link,
                                $usern,
                                $orderResult['status'] ?? 'pending',
                                $totalPrice,
                                null // user_id
                            ]
                        );
                    }
                    
                    $message = "ุชู ุฅูุดุงุก ุงูุทูุจ ุจูุฌุงุญ! ุฑูู ุงูุทูุจ: " . $orderResult['order'];
                    $messageType = 'success';
                    
                    header('Location: /track.php?order=' . urlencode($orderResult['order']));
                    exit;
                } else {
                    throw new Exception("ูุดู ูู ุฅูุดุงุก ุงูุทูุจ - ูู ูุชู ุงูุญุตูู ุนูู ุฑูู ุงูุทูุจ");
                }
        } else {
            $errorMsg = $orderResult['error'] ?? "ุฎุทุฃ ุบูุฑ ูุนุฑูู";
            throw new Exception("ุชุนุฐุฑ ุฅูุดุงุก ุงูุทูุจ ูุน ุงููุฒููุฏ. ุงูุฑุณุงูุฉ: " . $errorMsg);
        }
        }
    
        } catch (Exception $e) {
            $errorMessage = $e->getMessage();
            
            // Log the full error for debugging
            error_log("Order creation error: " . $errorMessage);
            
            // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ุนุฑุจูุฉ ูุงุถุญุฉ
            if (strpos($errorMessage, 'ุงููุฒููุฏ') !== false) {
                $supportMsg = 'ูุฑุญุจุงูุ ุฃุญุชุงุฌ ูุณุงุนุฏุฉ ุจุฎุตูุต ุทูุจ ุฎุฏูุฉ: ' . ($service['name_ar'] ?? $service['name']) . ' - ุฎุทุฃ ูู ุงูุชูุงุตู ูุน ุงููุฒูุฏ';
                $supportUrl = 'https://wa.me/' . WHATSAPP_NUMBER . '?text=' . urlencode($supportMsg);
                $message = "ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ูู ุงูุชูุงุตู ูุน ูุฒูุฏ ุงูุฎุฏูุฉ. <a href=\"" . htmlspecialchars($supportUrl) . "\" target=\"_blank\" rel=\"noopener\" class=\"btn btn-secondary\" style=\"margin: 0.5rem 0;\">๐ฑ ุชูุงุตู ูุน ุงูุฏุนู ุงูููู</a>";
            } elseif (strpos($errorMessage, 'format') !== false) {
                $message = "ูุฑุฌู ุงูุชุญูู ูู ุตุญุฉ ุงูุฑุงุจุท ุฃู ุงุณู ุงููุณุชุฎุฏู ุงููุฏุฎู.";
            } elseif (strpos($errorMessage, 'quantity') !== false) {
                $message = "ูุฑุฌู ุงูุชุญูู ูู ุงููููุฉ ุงููุฏุฎูุฉ (ูุฌุจ ุฃู ุชููู ุถูู ุงูุญุฏูุฏ ุงููุณููุญุฉ).";
            } else {
                $message = "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.";
            }
            
            $messageType = 'error';
        }

require_once BASE_PATH . '/templates/partials/header.php';
?>

<div class="container">
    <div class="card">
        <div class="card-header">
            <h1 class="card-title">ุชุฃููุฏ ุงูุทูุจ</h1>
            <p class="card-subtitle">ูุฑุงุฌุนุฉ ุชูุงุตูู ุทูุจู</p>
        </div>
        
        <?php if ($message): ?>
            <div class="alert alert-<?php echo $messageType; ?>">
                <?php echo $message; ?>
            </div>
        <?php endif; ?>
    </div>
</div>

<?php require_once BASE_PATH . '/templates/partials/footer.php'; ?>